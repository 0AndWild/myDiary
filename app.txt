from flask import Flask, render_template, jsonify, request, redirect, url_for

app = Flask(__name__)

from pymongo import MongoClient


import certifi
import jwt
import datetime
import hashlib

client = MongoClient('')
# client = MongoClient('내AWS아이피', 27017, username="아이디", password="비밀번호")
db = client.dbdiary

SECRET_KEY = 'CLAW'



@app.route('/')
def home():

    return render_template('post.html')


@app.route('/post', methods=['POST'])
def post():
    # token_receive = request.cookies.get('mytoken')
    try:
        # 토큰을 넘겨주지않아도 항상 쿠키로 토큰을 가져올 수 있다
        # payload = jwt.decode(token_receive, SECRET_KEY, algorithms=['HS256'])

        # 포스팅하기
        #user_info = db.users.find_one({"username": payload["id"]}) #유저 아이디정보
        image_receive = request.form["image"]
        nickname_receive = request.form["nickname"]
        title_receive = request.form["title"]
        date_receive = request.form["diary_date"]
        weather_receive = request.form["weather"]
        texts_receive = request.form["texts"]

        # num 가져오기
        diary_list = list(db.diary.find({}, {'_id': False}))
        count = len(diary_list) + 1
        doc = {
            'diary_num' : count,
            'image': image_receive,
            'nickname': nickname_receive,
            'title': title_receive,
            'diary_date': date_receive,
            'weather': weather_receive,
            'texts': texts_receive
        }
        # 위 데이터를 DB에 저장
        db.diary.insert_one(doc)


        return jsonify({"result": "success",'msg': '포스팅 성공'})
    except (jwt.ExpiredSignatureError, jwt.exceptions.DecodeError):
        return redirect(url_for("home"))
